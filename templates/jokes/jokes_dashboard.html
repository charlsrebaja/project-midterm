{% extends 'base.html' %}

{% block title %}JokeAPI & QR Generator - Security System{% endblock %}

{% block page_title %}JokeAPI & QR Generator{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="bg-gradient-to-r from-yellow-500 to-orange-500 rounded-xl shadow-lg p-6 text-white mb-8">
        <h2 class="text-2xl font-bold mb-2">Joke Generator with QR Codes</h2>
        <p class="opacity-90">Fetch random jokes, encrypt them, and generate QR codes</p>
    </div>
    
    <!-- Fetch Joke Button -->
    <div class="text-center mb-8">
        <button onclick="fetchJoke()" 
                id="fetchBtn"
                class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-bold py-4 px-8 rounded-lg hover:from-yellow-600 hover:to-orange-600 focus:outline-none focus:ring-4 focus:ring-yellow-300 transition-all duration-200 transform hover:scale-105 text-lg">
            <i class="fas fa-laugh-beam mr-2"></i>Get Random Joke
        </button>
    </div>
    
    <!-- Loading Spinner -->
    <div id="loading" class="hidden text-center mb-8">
        <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-orange-500 transition ease-in-out duration-150">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Fetching joke...
        </div>
    </div>
    
    <!-- Joke Display -->
    <div id="jokeContainer" class="hidden">
        <!-- Original Joke Card -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold">Original Joke</h3>
                <span id="jokeCategory" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm"></span>
            </div>
            <p id="jokeText" class="text-gray-700 text-lg leading-relaxed mb-4"></p>
            <div class="flex justify-center">
                <div id="originalQR" class="p-4 bg-gray-50 rounded-lg"></div>
            </div>
        </div>
        
        <!-- Encrypted Versions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Atbash Encrypted -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-3 rounded-lg mb-4">
                    <h4 class="font-semibold flex items-center">
                        <i class="fas fa-lock mr-2"></i>Atbash Cipher
                    </h4>
                </div>
                <div class="mb-4">
                    <p id="atbashText" class="text-sm text-gray-600 break-all line-clamp-3"></p>
                </div>
                <div class="flex justify-center mb-4">
                    <div id="atbashQR" class="p-2 bg-gray-50 rounded-lg"></div>
                </div>
                <button onclick="copyText('atbashText')" class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600 transition-colors">
                    <i class="fas fa-copy mr-2"></i>Copy Text
                </button>
            </div>
            
            <!-- Caesar Encrypted -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="bg-gradient-to-r from-green-500 to-teal-500 text-white p-3 rounded-lg mb-4">
                    <h4 class="font-semibold flex items-center">
                        <i class="fas fa-lock mr-2"></i>Caesar Cipher (Shift: 3)
                    </h4>
                </div>
                <div class="mb-4">
                    <p id="caesarText" class="text-sm text-gray-600 break-all line-clamp-3"></p>
                </div>
                <div class="flex justify-center mb-4">
                    <div id="caesarQR" class="p-2 bg-gray-50 rounded-lg"></div>
                </div>
                <button onclick="copyText('caesarText')" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition-colors">
                    <i class="fas fa-copy mr-2"></i>Copy Text
                </button>
            </div>
            
            <!-- Vigenere Encrypted -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white p-3 rounded-lg mb-4">
                    <h4 class="font-semibold flex items-center">
                        <i class="fas fa-lock mr-2"></i>Vigen√®re Cipher (Key: JOKE)
                    </h4>
                </div>
                <div class="mb-4">
                    <p id="vigenereText" class="text-sm text-gray-600 break-all line-clamp-3"></p>
                </div>
                <div class="flex justify-center mb-4">
                    <div id="vigenereQR" class="p-2 bg-gray-50 rounded-lg"></div>
                </div>
                <button onclick="copyText('vigenereText')" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    <i class="fas fa-copy mr-2"></i>Copy Text
                </button>
            </div>
        </div>
        
        <!-- Download All QR Codes Button -->
        <div class="mt-8 text-center">
            <button onclick="downloadAllQR()" class="bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-800 transition-colors">
                <i class="fas fa-download mr-2"></i>Download All QR Codes
            </button>
        </div>
    </div>
</div>

<style>
.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>

<script>
// Call fetchJoke when the page loads
document.addEventListener('DOMContentLoaded', function() {
    fetchJoke();
});

async function fetchJoke() {
    // Show loading, hide joke container
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('jokeContainer').classList.add('hidden');
    document.getElementById('fetchBtn').disabled = true;
    
    try {
        const response = await fetch('{% url "fetch_joke" %}');
        const data = await response.json();
        
        if (data.success) {
            // Display joke text
            document.getElementById('jokeText').textContent = data.joke;
            document.getElementById('jokeCategory').textContent = data.category;
            
            // Display encrypted versions
            document.getElementById('atbashText').textContent = data.encrypted.atbash;
            document.getElementById('caesarText').textContent = data.encrypted.caesar;
            document.getElementById('vigenereText').textContent = data.encrypted.vigenere;
            
            // Display QR codes
            displayQRCode('originalQR', data.qr_codes.original);
            displayQRCode('atbashQR', data.qr_codes.atbash);
            displayQRCode('caesarQR', data.qr_codes.caesar);
            displayQRCode('vigenereQR', data.qr_codes.vigenere);
            
            // Store QR codes for download
            window.qrCodes = data.qr_codes;
            
            // Show joke container
            document.getElementById('jokeContainer').classList.remove('hidden');
        } else {
            alert('Error fetching joke: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error);
    } finally {
        // Hide loading
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('fetchBtn').disabled = false;
    }
}

function displayQRCode(elementId, qrDataUrl) {
    const container = document.getElementById(elementId);
    container.innerHTML = `<img src="${qrDataUrl}" alt="QR Code" class="w-48 h-48">`;
}

function copyText(elementId) {
    const text = document.getElementById(elementId).textContent;
    navigator.clipboard.writeText(text).then(() => {
        // Show feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check mr-2"></i>Copied!';
        btn.classList.add('bg-gray-600');
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('bg-gray-600');
        }, 2000);
    });
}

function downloadAllQR() {
    if (!window.qrCodes) return;
    
    // Create a temporary container for download links
    const types = ['original', 'atbash', 'caesar', 'vigenere'];
    
    types.forEach(type => {
        const link = document.createElement('a');
        link.download = `joke_qr_${type}.png`;
        link.href = window.qrCodes[type];
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
}
</script>
{% endblock %}
